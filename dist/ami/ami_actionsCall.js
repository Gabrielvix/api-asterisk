"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.answer=answer,exports.clickToCall=clickToCall,exports.transfer=transfer;var _ami=require("./ami"),exec=require("child-process-promise").exec;async function command(a){return new Promise((b,c)=>{exec(`asterisk -rx '${a}'`).then(function(a){var d=a.stdout,e=a.stderr;return e?c(e):b(d)}).catch(function(a){console.error("ERROR: ",a)})})}function timeDelay(){return new Promise(a=>{setTimeout(()=>{a()},1400)})}async function clickToCall(a,b){try{return console.log("Chamou Rota ClickToCall",a),await _ami.customAmiClient.action({Action:"Originate",Exten:`${a.destination}`,Priority:"1",Variable:`SIPADDHEADER="Call-Info: <sip:${b}>\;answer-after=0"`,Channel:`Local/${a.ramal}`,CallerID:a.destination,Context:"from-internal"},!0,3e4).then(async b=>{let c=await command("core show channels concise"),d=null;return c=c.split("\n"),c.forEach(b=>{if(b.split("!")[0].includes(a.ramal)||b.split("!")[0].includes(a.destination)){const a=b.split("!");"macro-dial-one"==a[1]&&(d=a[a.length-1],console.log(a))}}),b.uniqueID=d,console.log(b),b}).catch(a=>{console.log(a)})}catch(a){return console.error("Erro ao fazer chamada:",a),{error:a.message};// ou qualquer outra forma de retornar o erro que seja útil para sua aplicação
}}async function transfer(a){return new Promise(async(b,c)=>{let d="",e=await command("core show channels concise");e=e.split("\n"),e.forEach(b=>{if(b.split("!")[0].includes(a.ramal_origin))return void(d=b.split("!")[0])}),""==d?c("Channel not found"):b(amiClient.action({Action:"Atxfer",Exten:a.ramal_destination,Priority:"1",Channel:d,Context:"from-internal"}))})}async function answer(a){return new Promise(async(b,c)=>{"undefined"==a.ramal_origin||""==a.ramal_origin||""==a.caller?c("Parametros Inv\xE1lidos"):b(amiClient.action({Action:"Originate",Channel:`Local/${a.ramal_origin}@from-internal`,Application:"Exec",CallerID:a.caller,Variable:`SIPADDHEADER="Call-Info: <sip:${ipAddress}>\;answer-after=0`,Data:`Pickup(${a.ramal_origin}&${a.ramal_origin}@PICKUPMARK)`},!0))})}